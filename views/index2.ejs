<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Google Map - Clustered Markers</title>
   <link rel="stylesheet" href="/index.css">
   <script>
        async function fetchCompanyData() {
            try {
                const response = await fetch('/api/companies');
                return await response.json();
            } catch (error) {
                console.error('ğŸš¨ Error fetching company data:', error);
                return [];
            }
        }
        function initMap() {
            const mapElement = document.getElementById("map");
            const searchInput = document.getElementById("search");
            const sidebarElement = document.getElementById("sidebar");

            if (!mapElement || !sidebarElement || !searchInput) {ã…
                console.error("âŒ 'map', 'sidebar', 'search' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }

            const busanCenter = { lat: 35.1796, lng: 129.0756 };
            const map = new google.maps.Map(mapElement, {
                zoom: 12,
                center: busanCenter,
            });

            const infoWindow = new google.maps.InfoWindow();
            let markers = [];  // ë§ˆì»¤ ë°°ì—´
            let companies = []; // ì „ì²´ íšŒì‚¬ ë°ì´í„°

            // ğŸ”¹ ë§ˆì»¤ì™€ ì‚¬ì´ë“œë°”ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
            function updateMarkers(filterText = "") {
                // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                markers.forEach(marker => marker.setMap(null));
                sidebarElement.innerHTML = ""; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
                markers = []; // ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”

                companies
                    .filter(company => company.name.toLowerCase().includes(filterText.toLowerCase()))
                    .forEach((company, i) => {
                        const position = {
                            lat: parseFloat(company.latitude),
                            lng: parseFloat(company.longitude),
                        };

                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: company.name,
                        });

                        marker.addListener("click", () => {
                            infoWindow.setContent(`
                                <strong>${company.name}</strong><br>
                                ğŸ“ ìœ„ë„: ${position.lat.toFixed(5)}<br>
                                ğŸ“ ê²½ë„: ${position.lng.toFixed(5)}
                            `);
                            infoWindow.open(map, marker);
                        });

                        markers.push(marker);

                        const listItem = document.createElement("div");
                        listItem.className = "list-item";
                        listItem.innerHTML = `
                            <strong class="location-name">${company.name}</strong><br>
                            ğŸ“ ìœ„ë„: ${position.lat.toFixed(5)} | ğŸ“ ê²½ë„: ${position.lng.toFixed(5)}
                        `;
                        listItem.addEventListener("click", () => {
                            map.setCenter(marker.getPosition());
                            map.setZoom(15);
                            google.maps.event.trigger(marker, "click");
                        });

                        sidebarElement.appendChild(listItem);
                    });
                new markerClusterer.MarkerClusterer({ map, markers });
            }

            fetchCompanyData().then(data => {
                companies = data;
                updateMarkers(); // ì´ˆê¸° ë§ˆì»¤ í‘œì‹œ
            });

            searchInput.addEventListener("input", (e) => {
                updateMarkers(e.target.value); // ê²€ìƒ‰ì–´ì— ë§ê²Œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            window.initMap = initMap;
        });
   </script>

   <script async defer
       src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&callback=initMap">
   </script>
   <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</head>
<body>
    <div class="main-content">
        <div class="side">
            <div class="header-bar">
                <h2 class="header-name">ESG ANALYSIS</h2>
                <div class="search-box">
                    <input id="search" placeholder="ê²€ìƒ‰...">
                    <div class="category-list">
                        <select id="category1" name="esg-rate">
                            <option value="select">í‰ì ë³„</option>
                        </select>
                        <select id="category2" name="category">
                            <option value="select">ì˜ˆì‹œ 1</option>
                            <option value="select2">ì˜ˆì‹œ 2</option>
                        </select>
                        <select id="category3" name="category">
                            <option value="select">ì˜ˆì‹œ 3</option>
                            <option value="select2">ì˜ˆì‹œ 4</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="sidebar"></div> <!-- ìœ„ì¹˜ ë¦¬ìŠ¤íŠ¸ -->
        </div>
        <div id="map"></div> <!-- ì§€ë„ -->
    </div>
</body>
</html>
